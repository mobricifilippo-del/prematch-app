<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>PreMatch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    :root{--bg:#0d0f12;--card:#141821;--muted:#8a93a3;--acc:#2fe477;--acc2:#1db954}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#fff;font:16px system-ui, -apple-system, Segoe UI, Roboto}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#0f1218;border-bottom:1px solid #1b2230;position:sticky;top:0;z-index:3}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    nav a{color:#fff;text-decoration:none;margin-left:18px;opacity:.9}
    nav a:hover{opacity:1}
    main{max-width:980px;margin:0 auto;padding:22px 14px 48px}
    h1{font-size:28px;margin:8px 0 6px} p.lead{color:var(--muted);margin-top:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid #1c2331;border-radius:14px;padding:14px}
    .title{font-weight:700;margin:0 0 6px}
    .muted{color:var(--muted);font-size:14px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .btn{display:inline-block;background:var(--acc);color:#001b09;font-weight:700;border-radius:10px;padding:8px 12px;text-decoration:none;border:none;cursor:pointer}
    .btn.secondary{background:#273042;color:#e7f6ff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;gap:8px;margin:12px 0}
    .crumbs{color:var(--muted);font-size:14px;margin:8px 0 16px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{background:var(--card);border:1px solid #1c2331;border-radius:12px;padding:12px}
    .spacer{height:8px}
    .footer{margin-top:36px;color:var(--muted);font-size:13px;text-align:center}
    .empty{padding:18px;border:1px dashed #273042;border-radius:12px;background:#121622}
    .time{font-variant-numeric:tabular-nums}
    .chip{background:#233045;border:1px solid #304562;border-radius:999px;padding:2px 8px;font-size:12px;color:#b8d2ff}
    @media (hover:hover){ .item:hover,.card:hover{border-color:#2b3b55} }
  </style>
</head>
<body>
  <header>
    <div class="brand">üèüÔ∏è PreMatch</div>
    <nav>
      <a href="#" onclick="goHome();return false;">Home</a>
      <a href="#" onclick="viewSports();return false;">Sport</a>
      <a href="#" onclick="alert('Auth non necessaria per esplorare üôÇ');return false;">Accedi/Registrati</a>
    </nav>
  </header>

  <main id="app">
    <h1>Scegli lo sport</h1>
    <p class="lead">Naviga le societ√† e scopri le prossime partite. Nessuna registrazione richiesta per esplorare.</p>
    <div class="spacer"></div>
    <div class="toolbar">
      <button class="btn" onclick="viewSports()">Apri elenco sport</button>
    </div>
  </main>

  <div class="footer">¬© PreMatch ‚Äî semplice, pulita, veloce. Privacy by design.</div>

  <script>
    // ========= SUPABASE (gi√† configurato) =========
    const SUPABASE_URL = "https://hzzhypahrzclvfepstro.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6emh5cGFocnpjbHZmZXBzdHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NDAxNDUsImV4cCI6MjA3MTAxNjE0NX0.7niKgLcuDKQZQZxkQfxMYzz9fPT4Mm5wzWeq6r87TIY";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========= STATO SEMPLICE =========
    const S = {
      sport: null, // {id,nome}
      societa: null, // {id,nome}
      squadra: null // {id,nome}
    };
    const $ = sel => document.querySelector(sel);
    const app = $("#app");
    const fmtTime = iso => new Date(iso).toLocaleString();

    function crumbs() {
      const parts = [];
      parts.push(`<a href="#" onclick="goHome();return false;">Home</a>`);
      if (S.sport) parts.push(`<a href="#" onclick="viewSports();return false;">${escapeHTML(S.sport.nome)}</a>`);
      if (S.societa) parts.push(`<a href="#" onclick="viewSocieta(S.sport.id);return false;">${escapeHTML(S.societa.nome)}</a>`);
      if (S.squadra) parts.push(`<span>${escapeHTML(S.squadra.nome)}</span>`);
      return `<div class="crumbs">${parts.join(" ‚Ä∫ ")}</div>`;
    }
    function escapeHTML(s){return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

    // ========= VISTE =========
    function goHome(){
      S.sport=S.societa=S.squadra=null;
      app.innerHTML = `
        <h1>Scegli lo sport</h1>
        <p class="lead">Naviga le societ√† e scopri le prossime partite. Nessuna registrazione richiesta per esplorare.</p>
        <div class="toolbar"><button class="btn" onclick="viewSports()">Apri elenco sport</button></div>
      `;
    }

    async function viewSports(){
      S.sport=S.societa=S.squadra=null;
      app.innerHTML = `<h1>Sport</h1>${crumbs()}<div class="grid" id="grid"></div>`;
      const grid = $("#grid");
      const { data, error } = await sb.from("sports").select("id,nome").order("nome");
      if (error){ grid.innerHTML = `<div class="empty">Errore caricamento sport.</div>`; return; }
      if (!data || data.length===0){ grid.innerHTML = `<div class="empty">Nessuno sport presente.</div>`; return; }
      grid.innerHTML = data.map(sp => `
        <div class="card">
          <div class="title">${escapeHTML(sp.nome)}</div>
          <div class="muted">ID: ${escapeHTML(sp.id)}</div>
          <div class="spacer"></div>
          <button class="btn" onclick="S.sport=${json(sp)}; viewSocieta('${sp.id}')">Societ√†</button>
        </div>
      `).join("");
    }

    async function viewSocieta(sportId){
      S.societa=S.squadra=null;
      const header = `<h1>Societ√†</h1>${crumbs()}`;
      app.innerHTML = header + `<div class="list" id="list"></div>`;
      const list = $("#list");
      const { data, error } = await sb.from("societa").select("id,nome,regione_id,genere").eq("sport_id", sportId).order("nome");
      if (error){ list.innerHTML = `<div class="empty">Errore caricamento societ√†.</div>`; return; }
      if (!data || data.length===0){ list.innerHTML = `<div class="empty">Nessuna societ√† per questo sport.</div>`; return; }
      list.innerHTML = data.map(sc => `
        <div class="item">
          <div class="row">
            <div>
              <div class="title">${escapeHTML(sc.nome)}</div>
              <div class="muted">Regione: ${sc.regione_id??'-'} ¬∑ Genere: ${sc.genere??'-'}</div>
            </div>
            <div>
              <button class="btn secondary" onclick="S.societa=${json(sc)}; viewSquadre('${sc.id}')">Squadre</button>
              <button class="btn" onclick="S.societa=${json(sc)}; viewPartiteSocieta('${sc.id}')">Partite</button>
            </div>
          </div>
        </div>
      `).join("");
    }

    async function viewSquadre(societaId){
      S.squadra=null;
      app.innerHTML = `<h1>Squadre</h1>${crumbs()}<div class="list" id="list"></div>`;
      const list = $("#list");
      const { data, error } = await sb.from("squadre").select("id,nome").eq("societa_id", societaId).order("nome");
      if (error){ list.innerHTML = `<div class="empty">Errore caricamento squadre.</div>`; return; }
      if (!data || data.length===0){ list.innerHTML = `<div class="empty">Nessuna squadra per questa societ√†.</div>`; return; }
      list.innerHTML = data.map(sq => `
        <div class="item">
          <div class="row">
            <div>
              <div class="title">${escapeHTML(sq.nome)}</div>
              <div class="muted">ID: ${escapeHTML(sq.id)}</div>
            </div>
            <div>
              <button class="btn" onclick="S.squadra=${json(sq)}; viewPartiteSquadra('${sq.id}')">Partite</button>
            </div>
          </div>
        </div>
      `).join("");
    }

    async function viewPartiteSocieta(societaId){
      // prendo le squadre della societ√† e poi le partite dove squadra1_id ‚àà squadre
      const { data: squadre, error: e1 } = await sb.from("squadre").select("id").eq("societa_id", societaId);
      app.innerHTML = `<h1>Partite societ√†</h1>${crumbs()}<div class="list" id="list"></div>`;
      const list = $("#list");
      if (e1){ list.innerHTML = `<div class="empty">Errore caricamento squadre.</div>`; return; }
      if (!squadre || squadre.length===0){ list.innerHTML = `<div class="empty">Questa societ√† non ha squadre.</div>`; return; }
      const ids = squadre.map(x=>x.id);
      const { data, error } = await sb.from("partite")
        .select("id,data,luogo,stato,squadra1_id,squadra2_id")
        .in("squadra1_id", ids)
        .order("data",{ascending:true})
        .limit(50);
      renderPartite(list, data, error);
    }

    async function viewPartiteSquadra(squadraId){
      app.innerHTML = `<h1>Partite squadra</h1>${crumbs()}<div class="list" id="list"></div>`;
      const list = $("#list");
      const { data, error } = await sb.from("partite")
        .select("id,data,luogo,stato,squadra1_id,squadra2_id")
        .eq("squadra1_id", squadraId)
        .order("data",{ascending:true})
        .limit(50);
      renderPartite(list, data, error);
    }

    function renderPartite(container, data, error){
      if (error){ container.innerHTML = `<div class="empty">Errore caricamento partite.</div>`; return; }
      if (!data || data.length===0){ container.innerHTML = `<div class="empty">Nessuna partita trovata.</div>`; return; }
      container.innerHTML = data.map(p => `
        <div class="item">
          <div class="row">
            <div>
              <div class="title time">${fmtTime(p.data)}</div>
              <div class="muted">Luogo: ${escapeHTML(p.luogo ?? '-')}</div>
            </div>
            <div class="chip">${escapeHTML(p.stato ?? 'ok')}</div>
          </div>
        </div>
      `).join("");
    }

    // ========= UTIL =========
    function json(o){ return JSON.stringify(o).replace(/</g,'\\u003c') }

    // carica subito la lista sport se vuoi: viewSports();
  </script>
</body>
</html>
