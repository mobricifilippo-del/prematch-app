<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PreMatch</title>
  <meta name="description" content="PreMatch — semplice, pulita, veloce.">
  <style>
    :root{
      --bg:#0b1321; --panel:#0f1f32; --panel2:#0d1a2a;
      --text:#e8eef7; --muted:#9fb6cc; --brand:#19c37d; --chip:#0b7bdd; --accent:#6688ff;
      --radius:16px; --cardgap:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1000px 600px at 20% -10%, #0f2540 0%, #0b1321 60%, #0b1321 100%); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--text); text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 8px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:22px}
    .brand img{width:34px;height:34px;border-radius:8px}
    nav a{opacity:.85;margin-left:16px}
    .hero{background:linear-gradient(180deg, #0f1f32, #0b1321); border:1px solid #1b2b45; border-radius:20px; padding:22px;margin:12px 0 22px}
    h1{margin:6px 0 10px 0;font-size:36px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--cardgap)}
    @media (min-width:720px){ .grid{grid-template-columns:1fr} }
    .card{display:flex;align-items:center;gap:16px;padding:14px;background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid #1a2a45; border-radius:18px}
    .thumb{width:78px;height:78px;border-radius:16px; overflow:hidden; border:2px solid #223a63; background:#0a1a2e}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .card h3{margin:0 0 4px 0;font-size:24px}
    .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .chip{background:#152845;border:1px solid #243c65;padding:8px 12px;border-radius:999px;color:#d7e5f9}
    .btn{background:#2a55ea;border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700}
    .btn:disabled{opacity:.5}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:22px 0 8px}
    .list{display:grid;grid-template-columns:1fr;gap:var(--cardgap)}
    .divider{height:1px;background:#1b2b45;margin:24px 0}
    .selects{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:560px){ .selects{grid-template-columns:1fr} }
    select{appearance:none;width:100%;padding:12px;border-radius:12px;border:1px solid #27405f;background:#0f1f32;color:var(--text)}
    .footer{color:#94a9c6;font-size:13px;opacity:.8;margin:18px 0 8px}
    .empty{padding:14px 0;color:#a9bfd8}
    .error{padding:12px;border:1px solid #633;border-radius:12px;background:#2b1212;color:#ffd6d6}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="images/logo.png" alt="PreMatch logo" />
        <span>PreMatch</span>
      </div>
      <nav>
        <a href="#">Home</a>
        <a href="#sport">Sport</a>
        <a href="#login" id="loginBtn">Accedi/Registrati</a>
      </nav>
    </header>

    <section class="hero">
      <h1>Scegli lo sport</h1>
      <p class="muted">Naviga le società e scopri le prossime partite. Nessuna registrazione richiesta per esplorare.</p>
    </section>

    <!-- SPORT -->
    <div class="grid" id="sportGrid"></div>

    <div class="divider"></div>

    <!-- FILTRI -->
    <div class="section-title"><h2>Filtri</h2></div>
    <div class="selects">
      <select id="selSport"><option value="">Sport…</option></select>
      <select id="selGenere">
        <option value="">Genere…</option>
        <option value="M">Maschile</option>
        <option value="F">Femminile</option>
      </select>
      <select id="selRegione"><option value="">Regione…</option></select>
      <select id="selCategoria"><option value="">Categoria…</option></select>
      <select id="selGirone"><option value="">Girone…</option></select>
    </div>

    <!-- SOCIETÀ -->
    <div class="section-title"><h2>Società</h2><span class="muted" id="clubsCount"></span></div>
    <div class="list" id="clubs"></div>

    <!-- PREMATCH -->
    <div class="section-title"><h2>PreMatch</h2></div>
    <div class="list" id="prematch"></div>

    <div class="footer">© PreMatch — semplice, pulita, veloce. Privacy-friendly.</div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
/* ==============================
   1) INSERISCI QUI I TUOI VALORI
   ============================== */
const SUPABASE_URL       = "PASTE_YOUR_PROJECT_URL_HERE";        // <- incolla qui (es. https://xxxx.supabase.co)
const SUPABASE_ANON_KEY  = "PASTE_YOUR_ANON_PUBLIC_KEY_HERE";    // <- incolla qui

/* ===================================================================================
   2) CLIENT SUPABASE
   =================================================================================== */
if (!SUPABASE_URL.startsWith("http") || SUPABASE_ANON_KEY.length < 20) {
  document.body.insertAdjacentHTML("afterbegin",
    '<div class="wrap"><div class="error">Configura Supabase: apri <b>Project Settings → API</b>, copia <b>Project URL</b> e <b>anon public</b> e incollali nelle costanti <code>SUPABASE_URL</code> e <code>SUPABASE_ANON_KEY</code>.</div></div>');
}
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===================================================================================
   3) MAPPATURA IMMAGINI SPORT (usa i file che hai in /images)
   =================================================================================== */
const sportImagesByName = {
  "Calcio":        "images/calcio.jpg",
  "Futsal":        "images/futsal.jpg",
  "Basket":        "images/basket.jpg",
  "Volley":        "images/volley.jpg",
  "Beach Volley":  "images/beachvolley.jpg",
  "Pallanuoto":    "images/pallanuoto.jpg",
  "Rugby":         "images/rugby.jpg"
};

/* ===================================================================================
   4) UI HELPERS
   =================================================================================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const state = {
  sport: null, sportName: null,
  regione: null, regioneName: null,
  genere: null,
  categoria: null, categoriaLabel: null,
  girone: null, gironeName: null
};
function setText(el, txt){ if(el) el.textContent = txt; }

/* ===================================================================================
   5) CARICAMENTO SPORT (griglia in alto)
   =================================================================================== */
async function loadSports(){
  const { data, error } = await supabase.from('sports').select('id, nome').order('nome', {ascending:true});
  if (error){ console.error(error); return; }
  const grid = $('#sportGrid');
  grid.innerHTML = '';
  for (const s of data){
    // card sport
    const img = sportImagesByName[s.nome] || 'images/logo.png';
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="thumb"><img src="${img}" alt="${s.nome}"></div>
      <div style="flex:1">
        <h3>${s.nome}</h3>
        <div class="muted">Esplora società</div>
      </div>
      <button class="btn" data-open="${s.id}">Apri</button>
    `;
    // click su "Apri" → imposta sport e aggiorna filtri
    card.querySelector('button').addEventListener('click', ()=>{
      $('#selSport').value = s.id;
      state.sport = s.id; state.sportName = s.nome;
      refreshFiltersAndClubs();
      window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
    });
    grid.appendChild(card);
  }

  // anche il <select> Sport
  const sel = $('#selSport');
  sel.innerHTML = '<option value="">Sport…</option>' + data.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
}

/* ===================================================================================
   6) FILTRI: regioni / categorie / gironi
   =================================================================================== */
async function loadRegioni(){
  const { data, error } = await supabase.from('regioni').select('id, nome').order('nome', {ascending:true});
  if (error){ console.error(error); return; }
  $('#selRegione').innerHTML = '<option value="">Regione…</option>' + data.map(r=>`<option value="${r.id}">${r.nome}</option>`).join('');
}

async function loadCategorie(){
  // categorie in base a sport + (opzionale) regione + genere
  if (!state.sport){ $('#selCategoria').innerHTML = '<option value="">Categoria…</option>'; return; }
  let q = supabase.from('categorie').select('id, nome').eq('sport_id', state.sport).order('nome', {ascending:true});
  if (state.regione) q = q.eq('regione_id', state.regione);
  if (state.genere)  q = q.eq('genere', state.genere);
  const { data, error } = await q;
  if (error){ console.error(error); return; }
  $('#selCategoria').innerHTML = '<option value="">Categoria…</option>' + data.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
  // reset gironi
  $('#selGirone').innerHTML = '<option value="">Girone…</option>';
}

async function loadGironi(){
  if (!state.categoria){ $('#selGirone').innerHTML = '<option value="">Girone…</option>'; return; }
  const { data, error } = await supabase.from('gironi').select('id, nome').eq('categoria_id', state.categoria).order('nome', {ascending:true});
  if (error){ console.error(error); return; }
  $('#selGirone').innerHTML = '<option value="">Girone…</option>' + data.map(g=>`<option value="${g.id}">${g.nome}</option>`).join('');
}

/* ===================================================================================
   7) SOCIETA' (lista in basso)
   =================================================================================== */
async function loadClubs(){
  let q = supabase.from('societa').select('id, nome, sport_id, regione_id, categoria_id, girone_id').order('nome', {ascending:true});
  if (state.sport)     q = q.eq('sport_id', state.sport);
  if (state.regione)   q = q.eq('regione_id', state.regione);
  if (state.categoria) q = q.eq('categoria_id', state.categoria);
  if (state.girone)    q = q.eq('girone_id', state.girone);

  const { data, error } = await q;
  const list = $('#clubs');
  list.innerHTML = '';
  if (error){ console.error(error); list.innerHTML = '<div class="empty">Errore nel caricamento società.</div>'; return; }
  if (!data || !data.length){ list.innerHTML = '<div class="empty">Nessuna società trovata con i filtri selezionati.</div>'; setText($('#clubsCount'), '0'); return; }

  setText($('#clubsCount'), `${data.length} risultati`);
  for (const c of data){
    const sportName = state.sportName || '';
    const card = document.createElement('div');
    card.className = 'card';
    const img = sportImagesByName[sportName] || 'images/logo.png';
    card.innerHTML = `
      <div class="thumb"><img src="${img}" alt=""></div>
      <div style="flex:1">
        <h3>${c.nome}</h3>
        <div class="row">
          ${sportName? `<span class="chip">${sportName}</span>`:``}
          ${state.regioneName? `<span class="chip">${state.regioneName}</span>`:``}
          ${state.categoriaLabel? `<span class="chip">${state.categoriaLabel}</span>`:``}
          ${state.gironeName? `<span class="chip">${state.gironeName}</span>`:``}
        </div>
      </div>
      <button class="btn" data-prematch="${c.id}">Crea PreMatch</button>
    `;
    card.querySelector('button').addEventListener('click', ()=> createPrematch(c));
    list.appendChild(card);
  }
}

/* ===================================================================================
   8) HANDLERS FILTRI
   =================================================================================== */
$('#selSport').addEventListener('change', async (e)=>{
  state.sport = e.target.value || null;
  state.sportName = $('#selSport').selectedOptions[0]?.textContent || null;
  // reset campi cascata
  state.categoria = state.girone = null;
  $('#selCategoria').value = ''; $('#selGirone').value = '';
  await loadCategorie();
  await loadClubs();
});

$('#selGenere').addEventListener('change', async (e)=>{
  state.genere = e.target.value || null;
  await loadCategorie();
  await loadClubs();
});

$('#selRegione').addEventListener('change', async (e)=>{
  state.regione = e.target.value || null;
  state.regioneName = $('#selRegione').selectedOptions[0]?.textContent || null;
  await loadCategorie();
  await loadClubs();
});

$('#selCategoria').addEventListener('change', async (e)=>{
  state.categoria = e.target.value || null;
  state.categoriaLabel = $('#selCategoria').selectedOptions[0]?.textContent || null;
  await loadGironi();
  await loadClubs();
});

$('#selGirone').addEventListener('change', async (e)=>{
  state.girone = e.target.value || null;
  state.gironeName = $('#selGirone').selectedOptions[0]?.textContent || null;
  await loadClubs();
});

/* ===================================================================================
   9) CREAZIONE PREMATCH (placeholder locale + messaggio)
   =================================================================================== */
async function createPrematch(club){
  // Qui potrai agganciare la vera tabella `prematch`.
  // Per ora mostriamo solo un feedback “mock”.
  const box = $('#prematch');
  const el = document.createElement('div');
  el.className = 'card';
  el.innerHTML = `
    <div class="thumb"><img src="${sportImagesByName[state.sportName] || 'images/logo.png'}" alt=""></div>
    <div style="flex:1">
      <h3>PreMatch creato (bozza)</h3>
      <div class="muted">Società: <b>${club.nome}</b>${state.categoriaLabel? ' — ' + state.categoriaLabel:''}${state.gironeName? ' — ' + state.gironeName:''}</div>
    </div>
    <button class="btn" disabled>In arrivo</button>
  `;
  box.prepend(el);
}

/* ===================================================================================
   10) BOOTSTRAP
   =================================================================================== */
async function refreshFiltersAndClubs(){
  await loadCategorie();
  await loadGironi();
  await loadClubs();
}
(async function init(){
  await loadSports();
  await loadRegioni();
  await loadClubs();
})();
</script>
</body>
</html>
