<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PreMatch</title>
  <meta name="theme-color" content="#169b62" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --brand:#169b62; /* verde principale */
      --ink:#101214;
      --muted:#6b7280;
      --bg:#ffffff;
      --bg-soft:#f6f7f8;
      --ok:#16a34a;
      --wait:#d97706;
      --error:#b91c1c;
      --card: #ffffff;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol'}
    a{color:var(--brand);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .nav{
      position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:10
    }
    .nav .wrap{display:flex;align-items:center;gap:12px;padding:10px 16px}
    .logo{width:28px;height:28px;border-radius:6px;background:var(--brand);display:inline-grid;place-items:center;color:#fff;font-weight:800}
    .brand{font-weight:800;letter-spacing:.3px}
    .badge-free{margin-left:auto;background:#e8faf0;color:#0f5132;border:1px solid #c6f1d9;padding:4px 8px;border-radius:999px;font-size:12px}
    .grid{display:grid;gap:12px}
    .grid.sports{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .card:hover{box-shadow:0 2px 14px rgba(0,0,0,.06)}
    .section-title{display:flex;align-items:center;gap:10px;margin:20px 0 10px}
    .section-title h2{margin:0;font-size:18px}
    .soft{color:var(--muted);font-size:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .pill{border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer;background:#fff}
    .pill.active{border-color:var(--brand);outline:2px solid rgba(22,155,98,.15)}
    .select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .list{display:grid;gap:10px}
    .club{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff}
    .club h4{margin:0}
    .label{font-size:12px;color:#555}
    .kpi{display:inline-block;padding:4px 8px;border-radius:8px;border:1px solid var(--border);font-size:12px;background:#fff}
    .status{display:inline-flex;align-items:center;gap:6px;font-size:12px;border-radius:8px;padding:4px 8px;border:1px solid var(--border)}
    .status.ok{color:#0f5132;background:#e8faf0;border-color:#c6f1d9}
    .status.wait{color:#92400e;background:#fff7ed;border-color:#fed7aa}
    .footer{margin:40px 0 20px;color:var(--muted);font-size:12px;text-align:center}
    .breadcrumbs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px;color:#374151}
    .bc{display:inline-flex;gap:6px;align-items:center}
    .bc .x{color:#9ca3af;cursor:pointer}
    .sports-grid button{
      display:flex;gap:10px;align-items:center;width:100%;background:#fff;border:1px solid var(--border);
      border-radius:12px;padding:12px;text-align:left;cursor:pointer
    }
    .sports-grid .icon{font-size:22px}
    .divider{height:1px;background:var(--border);margin:10px 0}
  </style>
</head>
<body>
  <div class="nav">
    <div class="wrap">
      <div class="logo">PM</div>
      <div class="brand">PreMatch</div>
      <span class="badge-free">Gratuita ¬∑ senza pubblicit√† invasive</span>
    </div>
  </div>

  <div class="wrap">
    <!-- Breadcrumbs (stato scelta) -->
    <div class="breadcrumbs" id="breadcrumbs"></div>

    <!-- SPORT -->
    <div class="section-title"><h2>1) Scegli lo sport</h2><span class="soft">clicca per continuare</span></div>
    <div class="grid sports sports-grid" id="sports"></div>

    <!-- REGIONE -->
    <div class="section-title"><h2>2) Scegli la regione</h2><span class="soft">Italia</span></div>
    <select id="regioni" class="select"><option value="">‚Äî Seleziona regione ‚Äî</option></select>

    <!-- GENERE -->
    <div class="section-title"><h2>3) Genere</h2></div>
    <div class="row" id="genere">
      <div class="pill" data-gen="M">Maschile</div>
      <div class="pill" data-gen="F">Femminile</div>
    </div>

    <!-- CAMPIONATI -->
    <div class="section-title"><h2>4) Campionato</h2></div>
    <select id="campionati" class="select"><option value="">‚Äî Seleziona campionato ‚Äî</option></select>

    <!-- GIRONI -->
    <div class="section-title"><h2>5) Girone</h2></div>
    <select id="gironi" class="select"><option value="">‚Äî Seleziona girone ‚Äî</option></select>

    <!-- SOCIET√Ä -->
    <div class="section-title"><h2>Societ√†</h2><span class="soft">filtrate per sport e regione</span></div>
    <div class="list" id="clubs"></div>

    <!-- PREMATCH della societ√† selezionata -->
    <div class="section-title"><h2>PreMatch</h2><span class="soft">esempi demo</span></div>
    <div class="list" id="prematch"></div>

    <div class="divider"></div>
    <div class="footer">
      ¬© PreMatch ‚Äî semplice, pulita, veloce. Privacy prima di tutto.
    </div>
  </div>

<script>
  // 1) CONFIGURA QUI I TUOI PARAMETRI SUPABASE
  const YOUR_SUPABASE_URL_HERE = "YOUR_SUPABASE_URL_HERE";         // es. https://xxxx.supabase.co
  const YOUR_SUPABASE_ANON_KEY_HERE = "YOUR_SUPABASE_ANON_KEY_HERE";   // Settings ‚Üí API ‚Üí anon public key

  // 2) CLIENT
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // 3) STATO UI
  const state = {
    sport: null,
    sportName: null,
    regione: null,
    regioneName: null,
    genere: null,
    campionato: null,
    campionatoLabel: null,
    girone: null,
    gironeName: null,
    clubSelezionato: null,
  };

  // 4) ELEMENTI DOM
  const elSports = document.getElementById('sports');
  const elRegioni = document.getElementById('regioni');
  const elGenere = document.getElementById('genere');
  const elCampionati = document.getElementById('campionati');
  const elGironi = document.getElementById('gironi');
  const elClubs = document.getElementById('clubs');
  const elPreMatch = document.getElementById('prematch');
  const elBC = document.getElementById('breadcrumbs');

  // 5) UTILS UI
  function breadcrumbs(){
    elBC.innerHTML = '';
    const parts = [];
    if(state.sportName) parts.push({k:'Sport', v:state.sportName, onclear:()=>{state.sport=null;state.sportName=null;state.campionato=null;state.girone=null;state.genere=null;state.regione=null;state.regioneName=null;renderAll();}});
    if(state.regioneName) parts.push({k:'Regione', v:state.regioneName, onclear:()=>{state.regione=null;state.regioneName=null;state.campionato=null;state.girone=null;renderAll();}});
    if(state.genere) parts.push({k:'Genere', v:(state.genere==='M'?'Maschile':'Femminile'), onclear:()=>{state.genere=null;state.campionato=null;state.girone=null;renderAll();}});
    if(state.campionatoLabel) parts.push({k:'Campionato', v:state.campionatoLabel, onclear:()=>{state.campionato=null;state.girone=null;renderAll();}});
    if(state.gironeName) parts.push({k:'Girone', v:state.gironeName, onclear:()=>{state.girone=null;renderAll();}});

    for(const p of parts){
      const span = document.createElement('span');
      span.className='bc';
      span.innerHTML = `<strong>${p.k}:</strong> ${p.v} <span class="x">‚úï</span>`;
      span.querySelector('.x').onclick=p.onclear;
      elBC.appendChild(span);
    }
  }

  function opt(el, value, label){
    const o = document.createElement('option');
    o.value = value; o.textContent = label;
    el.appendChild(o);
  }

  function clearSelect(el, placeholder){
    el.innerHTML = '';
    opt(el,'', placeholder || '‚Äî Seleziona ‚Äî');
  }

  function pillActivate(gen){
    for(const node of elGenere.querySelectorAll('.pill')){
      node.classList.toggle('active', node.dataset.gen===gen);
    }
  }

  // 6) LOADERS
  async function loadSports(){
    const { data, error } = await supabase.from('sports').select('*').order('nome');
    if(error){ console.error(error); return; }
    elSports.innerHTML='';
    data.forEach(s=>{
      const btn = document.createElement('button');
      btn.innerHTML = `<span class="icon">üè∑Ô∏è</span><div><div style="font-weight:700">${s.nome}</div><div class="label">Seleziona</div></div>`;
      btn.onclick = ()=>{ state.sport = s.id; state.sportName = s.nome; state.campionato=null; state.girone=null; renderAll(); };
      const card = document.createElement('div'); card.className='card';
      card.appendChild(btn);
      const cell = document.createElement('div');
      cell.appendChild(card);
      elSports.appendChild(cell);
    });
  }

  async function loadRegioni(){
    const { data, error } = await supabase.from('regioni').select('*').order('nome');
    if(error){ console.error(error); return; }
    clearSelect(elRegioni,'‚Äî Seleziona regione ‚Äî');
    data.forEach(r => opt(elRegioni, r.id, r.nome));
    if(state.regione) elRegioni.value = state.regione;
  }

  async function loadCampionati(){
    clearSelect(elCampionati,'‚Äî Seleziona campionato ‚Äî');
    if(!(state.sport && state.regione && state.genere)) return;
    const { data, error } = await supabase
      .from('campionati')
      .select('id, livello, stagione')
      .eq('sport_id', state.sport)
      .eq('regione_id', state.regione)
      .eq('genere', state.genere)
      .order('livello');
    if(error){ console.error(error); return; }
    data.forEach(c => opt(elCampionati, c.id, `${c.livello} ¬∑ ${c.stagione}`));
    if(state.campionato) elCampionati.value = state.campionato;
  }

  async function loadGironi(){
    clearSelect(elGironi,'‚Äî Seleziona girone ‚Äî');
    if(!state.campionato) return;
    const { data, error } = await supabase
      .from('gironi')
      .select('id, nome')
      .eq('campionato_id', state.campionato)
      .order('nome');
    if(error){ console.error(error); return; }
    data.forEach(g => opt(elGironi, g.id, g.nome));
    if(state.girone) elGironi.value = state.girone;
  }

  async function loadClubs(){
    elClubs.innerHTML='';
    if(!(state.sport && state.regione)) return;
    const { data, error } = await supabase
      .from('societa')
      .select('id, nome, verificata')
      .eq('sport_id', state.sport)
      .eq('regione_id', state.regione)
      .order('nome');
    if(error){ console.error(error); return; }
    if(!data.length){ elClubs.innerHTML='<div class="soft">Nessuna societ√† trovata per questi filtri.</div>'; return; }
    data.forEach(cl=>{
      const row = document.createElement('div'); row.className='club';
      row.innerHTML = `
        <div>
          <h4>${cl.nome}</h4>
          <div class="label">${cl.verificata ? '‚úÖ Verificata' : 'üü° Non verificata'} ¬∑ ${state.sportName} ¬∑ ${state.regioneName||''}</div>
        </div>
        <div class="row">
          <span class="kpi">Profilo</span>
          <button class="pill" aria-label="Apri prematch">Apri</button>
        </div>`;
      row.querySelector('button').onclick = ()=>{ state.clubSelezionato = cl.id; loadPreMatch(); };
      elClubs.appendChild(row);
    });
  }

  async function loadPreMatch(){
    elPreMatch.innerHTML='';
    if(!state.clubSelezionato){ elPreMatch.innerHTML='<div class="soft">Seleziona una societ√†.</div>'; return; }
    const { data, error } = await supabase
      .from('prematch')
      .select('id, data_partita, luogo, stato, societa_id, avversaria_societa_id')
      .or(`societa_id.eq.${state.clubSelezionato},avversaria_societa_id.eq.${state.clubSelezionato}`)
      .order('data_partita', { ascending: true });
    if(error){ console.error(error); return; }
    if(!data.length){ elPreMatch.innerHTML='<div class="soft">Nessun PreMatch disponibile.</div>'; return; }
    data.forEach(pm=>{
      const d = pm.data_partita ? new Date(pm.data_partita) : null;
      const statusClass = pm.stato==='confermato' ? 'ok' : (pm.stato==='in_attesa' ? 'wait' : '');
      const card = document.createElement('div'); card.className='club';
      card.innerHTML = `
        <div>
          <h4>${pm.luogo || 'Luogo da definire'}</h4>
          <div class="label">${d? d.toLocaleString(): 'data da definire'}</div>
        </div>
        <span class="status ${statusClass}">${pm.stato==='confermato'?'‚óè PREMATCH CONFERMATO': (pm.stato==='in_attesa'?'‚óè In attesa di verifica':'‚óè Bozza')}</span>
      `;
      elPreMatch.appendChild(card);
    });
  }

  // 7) EVENTI UI
  elRegioni.addEventListener('change', ()=>{
    state.regione = elRegioni.value || null;
    state.regioneName = elRegioni.options[elRegioni.selectedIndex]?.text || null;
    state.campionato = null; state.campionatoLabel=null; state.girone=null; state.gironeName=null;
    renderAll();
  });

  elGenere.querySelectorAll('.pill').forEach(p=>{
    p.addEventListener('click', ()=>{
      state.genere = p.dataset.gen;
      pillActivate(state.genere);
      state.campionato=null; state.campionatoLabel=null; state.girone=null; state.gironeName=null;
      renderAll();
    });
  });

  elCampionati.addEventListener('change', ()=>{
    state.campionato = elCampionati.value || null;
    state.campionatoLabel = elCampionati.options[elCampionati.selectedIndex]?.text || null;
    state.girone = null; state.gironeName = null;
    renderAll();
  });

  elGironi.addEventListener('change', ()=>{
    state.girone = elGironi.value || null;
    state.gironeName = elGironi.options[elGironi.selectedIndex]?.text || null;
    renderAll();
  });

  // 8) RENDER CICLO
  async function renderAll(){
    breadcrumbs();
    await Promise.all([
      (!state.sport ? loadSports() : Promise.resolve()),
      loadRegioni()
    ]);
    pillActivate(state.genere);
    await loadCampionati();
    await loadGironi();
    await loadClubs();
    await loadPreMatch();
  }

  // 9) AVVIO
  renderAll();
</script>
</body>
</html>
